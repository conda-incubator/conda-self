name: conda-self tests

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/tests.yml"
      - "conda_self/**"
      - "pixi.lock"
      - "pyproject.toml"
      - "recipe/**"
      - "tests/**"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/tests.yml"
      - "conda_self/**"
      - "pixi.lock"
      - "pyproject.toml"
      - "recipe/**"
      - "tests/**"

concurrency:
  # Concurrency group that uses the workflow name and PR number if available
  # or commit SHA as a fallback. If a new build is triggered under that
  # concurrency group while a previous build is running it will be canceled.
  # Repeated pushes to a PR will cancel all previous builds, while multiple
  # merges to main will not cancel.
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  # TODO: Re-enable full pixi-based matrix when conda 26.1.0 is released
  # This PR requires the new health check API (fixer with ConfirmCallback)
  # which is only available in conda-canary builds for now.
  #
  # Full matrix to restore:
  #   os: [ubuntu-latest, windows-latest]
  #   channel: [defaults, conda-forge]
  #   python-version: ["310", "311", "312", "313"]
  #   include:
  #     - os: macos-15-intel
  #       channel: conda-forge
  #       python-version: "310"
  #     - os: macos-latest
  #       channel: defaults
  #       python-version: "313"
  #     - os: ubuntu-latest
  #       channel: conda-canary
  #       python-version: "313"

  tests:
    name: ubuntu-latest, py312, conda-canary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Miniconda with canary conda
        uses: conda-incubator/setup-miniconda@fc2d68f6413eb2d87b895e92f8584b5b94a10167 # v3
        with:
          auto-update-conda: false
          python-version: "3.12"
          channels: conda-canary/label/dev,conda-forge
          channel-priority: strict

      - name: Install test dependencies
        shell: bash -el {0}
        run: |
          # Install conda from canary channel (has unreleased health check API)
          conda install -y -c conda-canary/label/dev -c conda-forge conda pytest pytest-mock
          pip install -e .

      - name: Show conda info
        shell: bash -el {0}
        run: |
          conda info
          # Verify the health check fixer API exists (ConfirmCallback is TYPE_CHECKING only)
          python -c "from conda.plugins.types import CondaHealthCheck; print(f'fixer field: {CondaHealthCheck.__dataclass_fields__[\"fixer\"]}')"

      - name: Run tests
        shell: bash -el {0}
        env:
          TEST_CONDA_CHANNEL: conda-canary
        run: pytest -vv
